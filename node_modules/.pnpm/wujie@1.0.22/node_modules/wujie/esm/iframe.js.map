{"version":3,"file":"iframe.js","names":["renderElementToContainer","syncUrlToWindow","fixElementCtrSrcOrHref","isConstructable","anchorElementGenerator","isMatchSyncQueryById","warn","error","execHooks","getCurUrl","getAbsolutePath","setAttrsToElement","setTagToScript","getTagFromScript","documentProxyProperties","rawAddEventListener","rawRemoveEventListener","rawDocumentQuerySelector","mainDocumentAddEventListenerEvents","mainAndAppAddEventListenerEvents","appDocumentAddEventListenerEvents","appDocumentOnEvents","appWindowAddEventListenerEvents","appWindowOnEvent","windowProxyProperties","windowRegWhiteList","rawWindowAddEventListener","rawWindowRemoveEventListener","getJsLoader","WUJIE_TIPS_SCRIPT_ERROR_REQUESTED","WUJIE_DATA_FLAG","patchIframeEvents","iframeWindow","__WUJIE_EVENTLISTENER__","Set","addEventListener","type","listener","options","__WUJIE","plugins","add","includes","_typeof","targetWindow","call","window","__WUJIE_RAW_WINDOW__","removeEventListener","forEach","o","patchIframeVariable","wujie","appHostPath","__WUJIE_PUBLIC_PATH__","$wujie","provide","patchIframeHistory","mainHostPath","history","rawHistoryPushState","pushState","rawHistoryReplaceState","replaceState","data","title","url","baseUrl","location","pathname","search","hash","mainUrl","replace","ignoreFlag","undefined","updateBase","_iframeWindow$locatio","URL","href","baseElement","document","setAttribute","patchWindowEffect","processWindowProperty","key","value","bind","e","message","Object","getOwnPropertyNames","defineProperty","get","some","reg","test","parent","windowOnEvents","filter","p","descriptor","getOwnPropertyDescriptor","enumerable","writable","configurable","set","handler","recordEventListeners","sandbox","Node","prototype","elementListenerList","elementEventCacheMap","find","push","index","findIndex","ele","splice","length","recoverEventListeners","rootElement","WeakMap","ElementIterator","createTreeWalker","NodeFilter","SHOW_ELEMENT","nextElement","currentNode","nextNode","recoverDocumentListeners","oldRootElement","newRootElement","patchEventTimeStamp","Event","createEvent","timeStamp","patchDocumentEffect","handlerCallbackMap","handlerTypeMap","Document","callback","typeList","degrade","shadowRoot","indexOf","elementOnEvents","keys","HTMLElement","documentOnEvent","firstElementChild","val","ownerProperties","modifyProperties","shadowProperties","shadowMethods","documentProperties","documentMethods","documentEvents","concat","propKey","proxyDocument","patchNodeEffect","rawGetRootNode","getRootNode","rawAppendChild","appendChild","rawInsertRule","insertBefore","rootNode","node","res","patchElementEffect","child","patchRelativeUrlEffect","HTMLImageElement","HTMLAnchorElement","HTMLSourceElement","HTMLLinkElement","HTMLScriptElement","HTMLMediaElement","initBase","iframeDocument","createElement","iframeUrlElement","appUrlElement","protocol","host","head","initIframeDom","newDoc","implementation","createHTMLDocument","newDocumentElement","importNode","documentElement","replaceChild","__WUJIE_RAW_DOCUMENT_HEAD__","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__","querySelector","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__","querySelectorAll","__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__","__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__","createTextNode","syncIframeUrlToWindow","stopIframeLoading","oldDoc","Promise","resolve","loop","setTimeout","err","stop","execCommand","element","proxyLocation","_hasPatch","defineProperties","baseURI","ownerDocument","console","insertScriptToIframe","scriptResult","rawElement","_ref","src","module","content","crossorigin","crossoriginType","async","attrs","onload","scriptElement","nextScriptElement","_iframeWindow$__WUJIE","jsLoader","code","String","textContent","container","execNextScript","afterExecScript","isOutlineScript","onerror","renderIframeReplaceApp","degradeAttrs","arguments","iframe","defaultStyle","_objectSpread","style","join","iframeGenerator","appRoutePath","attrsMerge","_defineProperty","name","id","body","contentWindow","iframeReady","then"],"sources":["../src/iframe.ts"],"sourcesContent":["import WuJie from \"./sandbox\";\nimport { ScriptObject } from \"./template\";\nimport { renderElementToContainer } from \"./shadow\";\nimport { syncUrlToWindow } from \"./sync\";\nimport {\n  fixElementCtrSrcOrHref,\n  isConstructable,\n  anchorElementGenerator,\n  isMatchSyncQueryById,\n  warn,\n  error,\n  execHooks,\n  getCurUrl,\n  getAbsolutePath,\n  setAttrsToElement,\n  setTagToScript,\n  getTagFromScript,\n} from \"./utils\";\nimport {\n  documentProxyProperties,\n  rawAddEventListener,\n  rawRemoveEventListener,\n  rawDocumentQuerySelector,\n  mainDocumentAddEventListenerEvents,\n  mainAndAppAddEventListenerEvents,\n  appDocumentAddEventListenerEvents,\n  appDocumentOnEvents,\n  appWindowAddEventListenerEvents,\n  appWindowOnEvent,\n  windowProxyProperties,\n  windowRegWhiteList,\n  rawWindowAddEventListener,\n  rawWindowRemoveEventListener,\n} from \"./common\";\nimport type { appAddEventListenerOptions } from \"./common\";\nimport { getJsLoader } from \"./plugin\";\nimport { WUJIE_TIPS_SCRIPT_ERROR_REQUESTED, WUJIE_DATA_FLAG } from \"./constant\";\nimport { ScriptObjectLoader } from \"./index\";\n\ndeclare global {\n  interface Window {\n    // 是否存在无界\n    __POWERED_BY_WUJIE__?: boolean;\n    // 子应用公共加载路径\n    __WUJIE_PUBLIC_PATH__: string;\n    // 原生的querySelector\n    __WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__: typeof Document.prototype.querySelector;\n\n    // iframe内原生的createElement\n    __WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__: typeof Document.prototype.createElement;\n\n    // iframe内原生的createTextNode\n    __WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__: typeof Document.prototype.createTextNode;\n\n    // iframe内原生的head\n    __WUJIE_RAW_DOCUMENT_HEAD__: typeof Document.prototype.head;\n\n    // 原生的querySelector\n    __WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__: typeof Document.prototype.querySelectorAll;\n    // 原生的window对象\n    __WUJIE_RAW_WINDOW__: Window;\n    // 子应用沙盒实例\n    __WUJIE: WuJie;\n    // 记录注册在主应用中的事件\n    __WUJIE_EVENTLISTENER__: Set<{ listener: EventListenerOrEventListenerObject; type: string; options: any }>;\n    // 子应用mount函数\n    __WUJIE_MOUNT: () => void;\n    // 子应用unmount函数\n    __WUJIE_UNMOUNT: () => void;\n    // document type\n    Document: typeof Document;\n    // img type\n    HTMLImageElement: typeof HTMLImageElement;\n    // node type\n    Node: typeof Node;\n    // element type\n    Element: typeof Element;\n    // htmlElement typeof\n    HTMLElement: typeof HTMLElement;\n    // anchor type\n    HTMLAnchorElement: typeof HTMLAnchorElement;\n    // source type\n    HTMLSourceElement: typeof HTMLSourceElement;\n    // link type\n    HTMLLinkElement: typeof HTMLLinkElement;\n    // script type\n    HTMLScriptElement: typeof HTMLScriptElement;\n    // media type\n    HTMLMediaElement: typeof HTMLMediaElement;\n    EventTarget: typeof EventTarget;\n    Event: typeof Event;\n    ShadowRoot: typeof ShadowRoot;\n    // 注入对象\n    $wujie: { [key: string]: any };\n  }\n  interface HTMLHeadElement {\n    _cacheListeners: Map<string, EventListenerOrEventListenerObject[]>;\n  }\n  interface HTMLBodyElement {\n    _cacheListeners: Map<string, EventListenerOrEventListenerObject[]>;\n  }\n  interface Document {\n    createTreeWalker(\n      root: Node,\n      whatToShow?: number,\n      filter?: NodeFilter | null,\n      entityReferenceExpansion?: boolean\n    ): TreeWalker;\n  }\n}\n\n/**\n * 修改window对象的事件监听，只有路由事件采用iframe的事件\n */\nfunction patchIframeEvents(iframeWindow: Window) {\n  iframeWindow.__WUJIE_EVENTLISTENER__ = iframeWindow.__WUJIE_EVENTLISTENER__ || new Set();\n  iframeWindow.addEventListener = function addEventListener<K extends keyof WindowEventMap>(\n    type: K,\n    listener: (this: Window, ev: WindowEventMap[K]) => any,\n    options?: boolean | appAddEventListenerOptions\n  ) {\n    // 运行插件钩子函数\n    execHooks(iframeWindow.__WUJIE.plugins, \"windowAddEventListenerHook\", iframeWindow, type, listener, options);\n    // 相同参数多次调用 addEventListener 不会导致重复注册，所以用set。\n    iframeWindow.__WUJIE_EVENTLISTENER__.add({ type, listener, options });\n    if (appWindowAddEventListenerEvents.includes(type) || (typeof options === \"object\" && options.targetWindow)) {\n      const targetWindow = typeof options === \"object\" && options.targetWindow ? options?.targetWindow : iframeWindow;\n      return rawWindowAddEventListener.call(targetWindow, type, listener, options);\n    }\n    // 在子应用嵌套场景使用window.window获取真实window\n    rawWindowAddEventListener.call(window.__WUJIE_RAW_WINDOW__ || window, type, listener, options);\n  };\n\n  iframeWindow.removeEventListener = function removeEventListener<K extends keyof WindowEventMap>(\n    type: K,\n    listener: (this: Window, ev: WindowEventMap[K]) => any,\n    options?: boolean | appAddEventListenerOptions\n  ) {\n    // 运行插件钩子函数\n    execHooks(iframeWindow.__WUJIE.plugins, \"windowRemoveEventListenerHook\", iframeWindow, type, listener, options);\n    iframeWindow.__WUJIE_EVENTLISTENER__.forEach((o) => {\n      // 这里严格一点，确保子应用销毁的时候都能销毁\n      if (o.listener === listener && o.type === type && options == o.options) {\n        iframeWindow.__WUJIE_EVENTLISTENER__.delete(o);\n      }\n    });\n    if (appWindowAddEventListenerEvents.includes(type) || (typeof options === \"object\" && options.targetWindow)) {\n      const targetWindow = typeof options === \"object\" && options.targetWindow ? options?.targetWindow : iframeWindow;\n      return rawWindowRemoveEventListener.call(targetWindow, type, listener, options);\n    }\n    rawWindowRemoveEventListener.call(window.__WUJIE_RAW_WINDOW__ || window, type, listener, options);\n  };\n}\n\nfunction patchIframeVariable(iframeWindow: Window, wujie: WuJie, appHostPath: string): void {\n  iframeWindow.__WUJIE = wujie;\n  iframeWindow.__WUJIE_PUBLIC_PATH__ = appHostPath + \"/\";\n  iframeWindow.$wujie = wujie.provide;\n  iframeWindow.__WUJIE_RAW_WINDOW__ = iframeWindow;\n}\n\n/**\n * 对iframe的history的pushState和replaceState进行修改\n * 将从location劫持后的数据修改回来，防止跨域错误\n * 同步路由到主应用\n * @param iframeWindow\n * @param appHostPath 子应用的 host path\n * @param mainHostPath 主应用的 host path\n */\nfunction patchIframeHistory(iframeWindow: Window, appHostPath: string, mainHostPath: string): void {\n  const history = iframeWindow.history;\n  const rawHistoryPushState = history.pushState;\n  const rawHistoryReplaceState = history.replaceState;\n  history.pushState = function (data: any, title: string, url?: string): void {\n    const baseUrl =\n      mainHostPath + iframeWindow.location.pathname + iframeWindow.location.search + iframeWindow.location.hash;\n    const mainUrl = getAbsolutePath(url?.replace(appHostPath, \"\"), baseUrl);\n    const ignoreFlag = url === undefined;\n\n    rawHistoryPushState.call(history, data, title, ignoreFlag ? undefined : mainUrl);\n    if (ignoreFlag) return;\n    updateBase(iframeWindow, appHostPath, mainHostPath);\n    syncUrlToWindow(iframeWindow);\n  };\n  history.replaceState = function (data: any, title: string, url?: string): void {\n    const baseUrl =\n      mainHostPath + iframeWindow.location.pathname + iframeWindow.location.search + iframeWindow.location.hash;\n    const mainUrl = getAbsolutePath(url?.replace(appHostPath, \"\"), baseUrl);\n    const ignoreFlag = url === undefined;\n\n    rawHistoryReplaceState.call(history, data, title, ignoreFlag ? undefined : mainUrl);\n    if (ignoreFlag) return;\n    updateBase(iframeWindow, appHostPath, mainHostPath);\n    syncUrlToWindow(iframeWindow);\n  };\n}\n\n/**\n * 动态的修改iframe的base地址\n * @param iframeWindow\n * @param appHostPath\n * @param mainHostPath\n */\nfunction updateBase(iframeWindow: Window, appHostPath: string, mainHostPath: string) {\n  const baseUrl = new URL(iframeWindow.location.href?.replace(mainHostPath, \"\"), appHostPath);\n  const baseElement = rawDocumentQuerySelector.call(iframeWindow.document, \"base\");\n  if (baseElement) baseElement.setAttribute(\"href\", appHostPath + baseUrl.pathname);\n}\n\n/**\n * patch iframe window effect\n * @param iframeWindow\n */\n// TODO 继续改进\nfunction patchWindowEffect(iframeWindow: Window): void {\n  // 属性处理函数\n  function processWindowProperty(key: string): boolean {\n    const value = iframeWindow[key];\n    try {\n      if (typeof value === \"function\" && !isConstructable(value)) {\n        iframeWindow[key] = window[key].bind(window);\n      } else {\n        iframeWindow[key] = window[key];\n      }\n      return true;\n    } catch (e) {\n      warn(e.message);\n      return false;\n    }\n  }\n  Object.getOwnPropertyNames(iframeWindow).forEach((key) => {\n    // 特殊处理\n    if (key === \"getSelection\") {\n      Object.defineProperty(iframeWindow, key, {\n        get: () => iframeWindow.document[key],\n      });\n      return;\n    }\n    // 单独属性\n    if (windowProxyProperties.includes(key)) {\n      processWindowProperty(key);\n      return;\n    }\n    // 正则匹配，可以一次处理多个\n    windowRegWhiteList.some((reg) => {\n      if (reg.test(key) && key in iframeWindow.parent) {\n        return processWindowProperty(key);\n      }\n      return false;\n    });\n  });\n  // onEvent set\n  const windowOnEvents = Object.getOwnPropertyNames(window)\n    .filter((p) => /^on/.test(p))\n    .filter((e) => !appWindowOnEvent.includes(e));\n\n  // 走主应用window\n  windowOnEvents.forEach((e) => {\n    const descriptor = Object.getOwnPropertyDescriptor(iframeWindow, e) || {\n      enumerable: true,\n      writable: true,\n    };\n    try {\n      Object.defineProperty(iframeWindow, e, {\n        enumerable: descriptor.enumerable,\n        configurable: true,\n        get: () => window[e],\n        set:\n          descriptor.writable || descriptor.set\n            ? (handler) => {\n                window[e] = typeof handler === \"function\" ? handler.bind(iframeWindow) : handler;\n              }\n            : undefined,\n      });\n    } catch (e) {\n      warn(e.message);\n    }\n  });\n  // 运行插件钩子函数\n  execHooks(iframeWindow.__WUJIE.plugins, \"windowPropertyOverride\", iframeWindow);\n}\n\n/**\n * 记录节点的监听事件\n */\nfunction recordEventListeners(iframeWindow: Window) {\n  const sandbox = iframeWindow.__WUJIE;\n  iframeWindow.Node.prototype.addEventListener = function (\n    type: string,\n    handler: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ): void {\n    // 添加事件缓存\n    const elementListenerList = sandbox.elementEventCacheMap.get(this);\n    if (elementListenerList) {\n      if (!elementListenerList.find((listener) => listener.type === type && listener.handler === handler)) {\n        elementListenerList.push({ type, handler, options });\n      }\n    } else sandbox.elementEventCacheMap.set(this, [{ type, handler, options }]);\n    return rawAddEventListener.call(this, type, handler, options);\n  };\n\n  iframeWindow.Node.prototype.removeEventListener = function (\n    type: string,\n    handler: EventListenerOrEventListenerObject,\n    options?: boolean | EventListenerOptions\n  ): void {\n    // 清除缓存\n    const elementListenerList = sandbox.elementEventCacheMap.get(this);\n    if (elementListenerList) {\n      const index = elementListenerList?.findIndex((ele) => ele.type === type && ele.handler === handler);\n      elementListenerList.splice(index, 1);\n    }\n    if (!elementListenerList?.length) {\n      sandbox.elementEventCacheMap.delete(this);\n    }\n    return rawRemoveEventListener.call(this, type, handler, options);\n  };\n}\n\n/**\n * 恢复节点的监听事件\n */\nexport function recoverEventListeners(rootElement: Element | ChildNode, iframeWindow: Window) {\n  const sandbox = iframeWindow.__WUJIE;\n  const elementEventCacheMap: WeakMap<\n    Node,\n    Array<{ type: string; handler: EventListenerOrEventListenerObject; options: any }>\n  > = new WeakMap();\n  const ElementIterator = document.createTreeWalker(rootElement, NodeFilter.SHOW_ELEMENT, null, false);\n  let nextElement = ElementIterator.currentNode;\n  while (nextElement) {\n    const elementListenerList = sandbox.elementEventCacheMap.get(nextElement);\n    if (elementListenerList?.length) {\n      elementEventCacheMap.set(nextElement, elementListenerList);\n      elementListenerList.forEach((listener) => {\n        nextElement.addEventListener(listener.type, listener.handler, listener.options);\n      });\n    }\n    nextElement = ElementIterator.nextNode() as HTMLElement;\n  }\n  sandbox.elementEventCacheMap = elementEventCacheMap;\n}\n\n/**\n * 恢复根节点的监听事件\n */\nexport function recoverDocumentListeners(\n  oldRootElement: Element | ChildNode,\n  newRootElement: Element | ChildNode,\n  iframeWindow: Window\n) {\n  const sandbox = iframeWindow.__WUJIE;\n  const elementEventCacheMap: WeakMap<\n    Node,\n    Array<{ type: string; handler: EventListenerOrEventListenerObject; options: any }>\n  > = new WeakMap();\n  const elementListenerList = sandbox.elementEventCacheMap.get(oldRootElement);\n  if (elementListenerList?.length) {\n    elementEventCacheMap.set(newRootElement, elementListenerList);\n    elementListenerList.forEach((listener) => {\n      newRootElement.addEventListener(listener.type, listener.handler, listener.options);\n    });\n  }\n  sandbox.elementEventCacheMap = elementEventCacheMap;\n}\n\n/**\n * 修复vue绑定事件e.timeStamp < attachedTimestamp 的情况\n */\nexport function patchEventTimeStamp(targetWindow: Window, iframeWindow: Window) {\n  Object.defineProperty(targetWindow.Event.prototype, \"timeStamp\", {\n    get: () => {\n      return iframeWindow.document.createEvent(\"Event\").timeStamp;\n    },\n  });\n}\n\n/**\n * patch document effect\n * @param iframeWindow\n */\n// TODO 继续改进\nfunction patchDocumentEffect(iframeWindow: Window): void {\n  const sandbox = iframeWindow.__WUJIE;\n\n  /**\n   * 处理 addEventListener和removeEventListener\n   * 由于这个劫持导致 handler 的this发生改变，所以需要handler.bind(document)\n   * 但是这样会导致removeEventListener无法正常工作，因为handler => handler.bind(document)\n   * 这个地方保存callback = handler.bind(document) 方便removeEventListener\n   */\n  const handlerCallbackMap: WeakMap<EventListenerOrEventListenerObject, EventListenerOrEventListenerObject> =\n    new WeakMap();\n  const handlerTypeMap: WeakMap<EventListenerOrEventListenerObject, Array<string>> = new WeakMap();\n  iframeWindow.Document.prototype.addEventListener = function (\n    type: string,\n    handler: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ): void {\n    if (!handler) return;\n    let callback = handlerCallbackMap.get(handler);\n    const typeList = handlerTypeMap.get(handler);\n    // 设置 handlerCallbackMap\n    if (!callback) {\n      callback = typeof handler === \"function\" ? handler.bind(this) : handler;\n      handlerCallbackMap.set(handler, callback);\n    }\n    // 设置 handlerTypeMap\n    if (typeList) {\n      if (!typeList.includes(type)) typeList.push(type);\n    } else {\n      handlerTypeMap.set(handler, [type]);\n    }\n\n    // 运行插件钩子函数\n    execHooks(iframeWindow.__WUJIE.plugins, \"documentAddEventListenerHook\", iframeWindow, type, callback, options);\n    if (appDocumentAddEventListenerEvents.includes(type)) {\n      return rawAddEventListener.call(this, type, callback, options);\n    }\n    // 降级统一走 sandbox.document\n    if (sandbox.degrade) return sandbox.document.addEventListener(type, callback, options);\n    if (mainDocumentAddEventListenerEvents.includes(type))\n      return window.document.addEventListener(type, callback, options);\n    if (mainAndAppAddEventListenerEvents.includes(type)) {\n      window.document.addEventListener(type, callback, options);\n      sandbox.shadowRoot.addEventListener(type, callback, options);\n      return;\n    }\n    sandbox.shadowRoot.addEventListener(type, callback, options);\n  };\n  iframeWindow.Document.prototype.removeEventListener = function (\n    type: string,\n    handler: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ): void {\n    const callback: EventListenerOrEventListenerObject = handlerCallbackMap.get(handler);\n    const typeList = handlerTypeMap.get(handler);\n    if (callback) {\n      if (typeList?.includes(type)) {\n        typeList.splice(typeList.indexOf(type), 1);\n        if (!typeList.length) {\n          handlerCallbackMap.delete(handler);\n          handlerTypeMap.delete(handler);\n        }\n      }\n\n      // 运行插件钩子函数\n      execHooks(iframeWindow.__WUJIE.plugins, \"documentRemoveEventListenerHook\", iframeWindow, type, callback, options);\n      if (appDocumentAddEventListenerEvents.includes(type)) {\n        return rawRemoveEventListener.call(this, type, callback, options);\n      }\n      if (sandbox.degrade) return sandbox.document.removeEventListener(type, callback, options);\n      if (mainDocumentAddEventListenerEvents.includes(type)) {\n        return window.document.removeEventListener(type, callback, options);\n      }\n      if (mainAndAppAddEventListenerEvents.includes(type)) {\n        window.document.removeEventListener(type, callback, options);\n        sandbox.shadowRoot.removeEventListener(type, callback, options);\n        return;\n      }\n      sandbox.shadowRoot.removeEventListener(type, callback, options);\n    }\n  };\n  // 处理onEvent\n  const elementOnEvents = Object.keys(iframeWindow.HTMLElement.prototype).filter((ele) => /^on/.test(ele));\n  const documentOnEvent = Object.keys(iframeWindow.Document.prototype)\n    .filter((ele) => /^on/.test(ele))\n    .filter((ele) => !appDocumentOnEvents.includes(ele));\n  elementOnEvents\n    .filter((e) => documentOnEvent.includes(e))\n    .forEach((e) => {\n      const descriptor = Object.getOwnPropertyDescriptor(iframeWindow.Document.prototype, e) || {\n        enumerable: true,\n        writable: true,\n      };\n      try {\n        Object.defineProperty(iframeWindow.Document.prototype, e, {\n          enumerable: descriptor.enumerable,\n          configurable: true,\n          get: () => (sandbox.degrade ? sandbox.document[e] : sandbox.shadowRoot.firstElementChild[e]),\n          set:\n            descriptor.writable || descriptor.set\n              ? (handler) => {\n                  const val = typeof handler === \"function\" ? handler.bind(iframeWindow.document) : handler;\n                  sandbox.degrade ? (sandbox.document[e] = val) : (sandbox.shadowRoot.firstElementChild[e] = val);\n                }\n              : undefined,\n        });\n      } catch (e) {\n        warn(e.message);\n      }\n    });\n  // 处理属性get\n  const {\n    ownerProperties,\n    modifyProperties,\n    shadowProperties,\n    shadowMethods,\n    documentProperties,\n    documentMethods,\n    documentEvents,\n  } = documentProxyProperties;\n  modifyProperties.concat(shadowProperties, shadowMethods, documentProperties, documentMethods).forEach((propKey) => {\n    const descriptor = Object.getOwnPropertyDescriptor(iframeWindow.Document.prototype, propKey) || {\n      enumerable: true,\n      writable: true,\n    };\n    try {\n      Object.defineProperty(iframeWindow.Document.prototype, propKey, {\n        enumerable: descriptor.enumerable,\n        configurable: true,\n        get: () => sandbox.proxyDocument[propKey],\n        set: undefined,\n      });\n    } catch (e) {\n      warn(e.message);\n    }\n  });\n  // 处理document专属事件\n  // TODO 内存泄露\n  documentEvents.forEach((propKey) => {\n    const descriptor = Object.getOwnPropertyDescriptor(iframeWindow.Document.prototype, propKey) || {\n      enumerable: true,\n      writable: true,\n    };\n    try {\n      Object.defineProperty(iframeWindow.Document.prototype, propKey, {\n        enumerable: descriptor.enumerable,\n        configurable: true,\n        get: () => (sandbox.degrade ? sandbox : window).document[propKey],\n        set:\n          descriptor.writable || descriptor.set\n            ? (handler) => {\n                (sandbox.degrade ? sandbox : window).document[propKey] =\n                  typeof handler === \"function\" ? handler.bind(iframeWindow.document) : handler;\n              }\n            : undefined,\n      });\n    } catch (e) {\n      warn(e.message);\n    }\n  });\n  // process owner property\n  ownerProperties.forEach((propKey) => {\n    Object.defineProperty(iframeWindow.document, propKey, {\n      enumerable: true,\n      configurable: true,\n      get: () => sandbox.proxyDocument[propKey],\n      set: undefined,\n    });\n  });\n  // 运行插件钩子函数\n  execHooks(iframeWindow.__WUJIE.plugins, \"documentPropertyOverride\", iframeWindow);\n}\n\n/**\n * patch Node effect\n * 1、处理 getRootNode\n * 2、处理 appendChild、insertBefore，当插入的节点为 svg 时，createElement 的 patch 会被去除，需要重新 patch\n * @param iframeWindow\n */\nfunction patchNodeEffect(iframeWindow: Window): void {\n  const rawGetRootNode = iframeWindow.Node.prototype.getRootNode;\n  const rawAppendChild = iframeWindow.Node.prototype.appendChild;\n  const rawInsertRule = iframeWindow.Node.prototype.insertBefore;\n  iframeWindow.Node.prototype.getRootNode = function (options?: GetRootNodeOptions): Node {\n    const rootNode = rawGetRootNode.call(this, options);\n    if (rootNode === iframeWindow.__WUJIE.shadowRoot) return iframeWindow.document;\n    else return rootNode;\n  };\n  iframeWindow.Node.prototype.appendChild = function <T extends Node>(node: T): T {\n    const res = rawAppendChild.call(this, node);\n    patchElementEffect(node, iframeWindow);\n    return res;\n  };\n  iframeWindow.Node.prototype.insertBefore = function <T extends Node>(node: T, child: Node | null): T {\n    const res = rawInsertRule.call(this, node, child);\n    patchElementEffect(node, iframeWindow);\n    return res;\n  };\n}\n\n/**\n * 修复资源元素的相对路径问题\n * @param iframeWindow\n */\nfunction patchRelativeUrlEffect(iframeWindow: Window): void {\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLImageElement, \"src\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLAnchorElement, \"href\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLSourceElement, \"src\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLLinkElement, \"href\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLScriptElement, \"src\");\n  fixElementCtrSrcOrHref(iframeWindow, iframeWindow.HTMLMediaElement, \"src\");\n}\n\n/**\n * 初始化base标签\n */\nexport function initBase(iframeWindow: Window, url: string): void {\n  const iframeDocument = iframeWindow.document;\n  const baseElement = iframeDocument.createElement(\"base\");\n  const iframeUrlElement = anchorElementGenerator(iframeWindow.location.href);\n  const appUrlElement = anchorElementGenerator(url);\n  baseElement.setAttribute(\"href\", appUrlElement.protocol + \"//\" + appUrlElement.host + iframeUrlElement.pathname);\n  iframeDocument.head.appendChild(baseElement);\n}\n\n/**\n * 初始化iframe的dom结构\n * @param iframeWindow\n * @param wujie\n * @param mainHostPath\n * @param appHostPath\n */\nfunction initIframeDom(iframeWindow: Window, wujie: WuJie, mainHostPath: string, appHostPath: string): void {\n  const iframeDocument = iframeWindow.document;\n  const newDoc = window.document.implementation.createHTMLDocument(\"\");\n  const newDocumentElement = iframeDocument.importNode(newDoc.documentElement, true);\n  iframeDocument.documentElement\n    ? iframeDocument.replaceChild(newDocumentElement, iframeDocument.documentElement)\n    : iframeDocument.appendChild(newDocumentElement);\n  iframeWindow.__WUJIE_RAW_DOCUMENT_HEAD__ = iframeDocument.head;\n  iframeWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__ = iframeWindow.Document.prototype.querySelector;\n  iframeWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__ = iframeWindow.Document.prototype.querySelectorAll;\n  iframeWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__ = iframeWindow.Document.prototype.createElement;\n  iframeWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__ = iframeWindow.Document.prototype.createTextNode;\n  initBase(iframeWindow, wujie.url);\n  patchIframeHistory(iframeWindow, appHostPath, mainHostPath);\n  patchIframeEvents(iframeWindow);\n  if (wujie.degrade) recordEventListeners(iframeWindow);\n  syncIframeUrlToWindow(iframeWindow);\n\n  patchWindowEffect(iframeWindow);\n  patchDocumentEffect(iframeWindow);\n  patchNodeEffect(iframeWindow);\n  patchRelativeUrlEffect(iframeWindow);\n}\n\n/**\n * 防止运行主应用的js代码，给子应用带来很多副作用\n */\n// TODO 更加准确抓取停止时机\nfunction stopIframeLoading(iframeWindow: Window) {\n  const oldDoc = iframeWindow.document;\n  return new Promise<void>((resolve) => {\n    function loop() {\n      setTimeout(() => {\n        let newDoc;\n        try {\n          newDoc = iframeWindow.document;\n        } catch (err) {\n          newDoc = null;\n        }\n        // wait for document ready\n        if (!newDoc || newDoc == oldDoc) {\n          loop();\n        } else {\n          iframeWindow.stop ? iframeWindow.stop() : iframeWindow.document.execCommand(\"Stop\");\n          resolve();\n        }\n      }, 1);\n    }\n    loop();\n  });\n}\n\nexport function patchElementEffect(\n  element: (HTMLElement | Node | ShadowRoot) & { _hasPatch?: boolean },\n  iframeWindow: Window\n): void {\n  const proxyLocation = iframeWindow.__WUJIE.proxyLocation as Location;\n  if (element._hasPatch) return;\n  try {\n    Object.defineProperties(element, {\n      baseURI: {\n        configurable: true,\n        get: () => proxyLocation.protocol + \"//\" + proxyLocation.host + proxyLocation.pathname,\n        set: undefined,\n      },\n      ownerDocument: {\n        configurable: true,\n        get: () => iframeWindow.document,\n      },\n      _hasPatch: { get: () => true },\n    });\n  } catch (error) {\n    console.warn(error);\n  }\n  execHooks(iframeWindow.__WUJIE.plugins, \"patchElementHook\", element, iframeWindow);\n}\n\n/**\n * 子应用前进后退，同步路由到主应用\n * @param iframeWindow\n */\nexport function syncIframeUrlToWindow(iframeWindow: Window): void {\n  iframeWindow.addEventListener(\"hashchange\", () => syncUrlToWindow(iframeWindow));\n  iframeWindow.addEventListener(\"popstate\", () => {\n    syncUrlToWindow(iframeWindow);\n  });\n}\n\n/**\n * iframe插入脚本\n * @param scriptResult script请求结果\n * @param iframeWindow\n * @param rawElement 原始的脚本\n */\nexport function insertScriptToIframe(\n  scriptResult: ScriptObject | ScriptObjectLoader,\n  iframeWindow: Window,\n  rawElement?: HTMLScriptElement\n) {\n  const { src, module, content, crossorigin, crossoriginType, async, attrs, callback, onload } =\n    scriptResult as ScriptObjectLoader;\n  const scriptElement = iframeWindow.document.createElement(\"script\");\n  const nextScriptElement = iframeWindow.document.createElement(\"script\");\n  const { replace, plugins, proxyLocation } = iframeWindow.__WUJIE;\n  const jsLoader = getJsLoader({ plugins, replace });\n  let code = jsLoader(content, src, getCurUrl(proxyLocation));\n  // 添加属性\n  attrs &&\n    Object.keys(attrs)\n      .filter((key) => !Object.keys(scriptResult).includes(key))\n      .forEach((key) => scriptElement.setAttribute(key, String(attrs[key])));\n\n  // 内联脚本\n  if (content) {\n    // patch location\n    if (!iframeWindow.__WUJIE.degrade && !module) {\n      code = `(function(window, self, global, location) {\n      ${code}\n}).bind(window.__WUJIE.proxy)(\n  window.__WUJIE.proxy,\n  window.__WUJIE.proxy,\n  window.__WUJIE.proxy,\n  window.__WUJIE.proxyLocation,\n);`;\n    }\n    const descriptor = Object.getOwnPropertyDescriptor(scriptElement, \"src\");\n    // 部分浏览器 src 不可配置 取不到descriptor表示无该属性，可写\n    if (descriptor?.configurable || !descriptor) {\n      // 解决 webpack publicPath 为 auto 无法加载资源的问题\n      try {\n        Object.defineProperty(scriptElement, \"src\", { get: () => src || \"\" });\n      } catch (error) {\n        console.warn(error);\n      }\n    }\n  } else {\n    src && scriptElement.setAttribute(\"src\", src);\n    crossorigin && scriptElement.setAttribute(\"crossorigin\", crossoriginType);\n  }\n  module && scriptElement.setAttribute(\"type\", \"module\");\n  scriptElement.textContent = code || \"\";\n  nextScriptElement.textContent =\n    \"if(window.__WUJIE.execQueue && window.__WUJIE.execQueue.length){ window.__WUJIE.execQueue.shift()()}\";\n\n  const container = rawDocumentQuerySelector.call(iframeWindow.document, \"head\");\n  const execNextScript = () => !async && container.appendChild(nextScriptElement);\n  const afterExecScript = () => {\n    onload?.();\n    execNextScript();\n  };\n\n  // 错误情况处理\n  if (/^<!DOCTYPE html/i.test(code)) {\n    error(WUJIE_TIPS_SCRIPT_ERROR_REQUESTED, scriptResult);\n    return execNextScript();\n  }\n\n  // 打标记\n  if (rawElement) {\n    setTagToScript(scriptElement, getTagFromScript(rawElement));\n  }\n  // 外联脚本执行后的处理\n  const isOutlineScript = !content && src;\n  if (isOutlineScript) {\n    scriptElement.onload = afterExecScript;\n    scriptElement.onerror = afterExecScript;\n  }\n  container.appendChild(scriptElement);\n\n  // 调用回调\n  callback?.(iframeWindow);\n  // 执行 hooks\n  execHooks(plugins, \"appendOrInsertElementHook\", scriptElement, iframeWindow, rawElement);\n  // 内联脚本执行后的处理\n  !isOutlineScript && afterExecScript();\n}\n\n/**\n * 加载iframe替换子应用\n * @param src 地址\n * @param element\n * @param degradeAttrs\n */\nexport function renderIframeReplaceApp(\n  src: string,\n  element: HTMLElement,\n  degradeAttrs: { [key: string]: any } = {}\n): void {\n  const iframe = window.document.createElement(\"iframe\");\n  const defaultStyle = \"height:100%;width:100%\";\n  setAttrsToElement(iframe, { ...degradeAttrs, src, style: [defaultStyle, degradeAttrs.style].join(\";\") });\n  renderElementToContainer(iframe, element);\n}\n\n/**\n * js沙箱\n * 创建和主应用同源的iframe，路径携带了子路由的路由信息\n * iframe必须禁止加载html，防止进入主应用的路由逻辑\n */\nexport function iframeGenerator(\n  sandbox: WuJie,\n  attrs: { [key: string]: any },\n  mainHostPath: string,\n  appHostPath: string,\n  appRoutePath: string\n): HTMLIFrameElement {\n  const iframe = window.document.createElement(\"iframe\");\n  const attrsMerge = { src: mainHostPath, style: \"display: none\", ...attrs, name: sandbox.id, [WUJIE_DATA_FLAG]: \"\" };\n  setAttrsToElement(iframe, attrsMerge);\n  window.document.body.appendChild(iframe);\n\n  const iframeWindow = iframe.contentWindow;\n  // 变量需要提前注入，在入口函数通过变量防止死循环\n  patchIframeVariable(iframeWindow, sandbox, appHostPath);\n  sandbox.iframeReady = stopIframeLoading(iframeWindow).then(() => {\n    if (!iframeWindow.__WUJIE) {\n      patchIframeVariable(iframeWindow, sandbox, appHostPath);\n    }\n    initIframeDom(iframeWindow, sandbox, mainHostPath, appHostPath);\n    /**\n     * 如果有同步优先同步，非同步从url读取\n     */\n    if (!isMatchSyncQueryById(iframeWindow.__WUJIE.id)) {\n      iframeWindow.history.replaceState(null, \"\", mainHostPath + appRoutePath);\n    }\n  });\n  return iframe;\n}\n"],"mappings":"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"}