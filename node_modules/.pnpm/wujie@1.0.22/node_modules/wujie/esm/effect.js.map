{"version":3,"file":"effect.js","names":["getExternalStyleSheets","getExternalScripts","getWujieById","rawAppendChild","rawElementContains","rawElementRemoveChild","rawHeadInsertBefore","rawBodyInsertBefore","rawDocumentQuerySelector","rawAddEventListener","rawRemoveEventListener","isFunction","isHijackingTag","warn","nextTick","getCurUrl","execHooks","isScriptElement","setTagToScript","getTagFromScript","setAttrsToElement","insertScriptToIframe","patchElementEffect","getPatchStyleElements","getCssLoader","getEffectLoaders","isMatchUrl","WUJIE_SCRIPT_ID","WUJIE_DATA_FLAG","WUJIE_TIPS_REPEAT_RENDER","WUJIE_TIPS_NO_SCRIPT","parseTagAttributes","patchCustomEvent","e","elementGetter","Object","defineProperties","srcElement","get","target","manualInvokeElementEvent","element","event","customEvent","CustomEvent","patchedEvent","concat","dispatchEvent","handleStylesheetElementPatch","stylesheetElement","sandbox","innerHTML","degrade","patcher","_getPatchStyleElement","sheet","_getPatchStyleElement2","_slicedToArray","hostStyleSheetElement","fontStyleSheetElement","shadowRoot","head","appendChild","host","_patcher","undefined","clearTimeout","setTimeout","patchStylesheetElement","cssLoader","curUrl","_stylesheetElement$sh","_hasPatchStyle","innerHTMLDesc","getOwnPropertyDescriptor","Element","prototype","innerTextDesc","HTMLElement","textContentDesc","Node","RawInsertRule","insertRule","patchSheetInsertRule","rule","index","innerText","call","set","code","_this","_this2","textContent","_this3","value","node","_this4","nodeType","TEXT_NODE","res","ownerDocument","createTextNode","dynamicScriptExecStack","Promise","resolve","rewriteAppendOrInsertChild","opts","appendChildOrInsertBefore","newChild","refChild","_this5","rawDOMAppendOrInsertBefore","wujieId","styleSheetElements","replace","fetch","plugins","iframe","lifecycles","proxyLocation","fiber","tagName","contentWindow","iframeDocument","contentDocument","_element$tagName","toUpperCase","_ref","href","rel","type","styleFlag","endsWith","src","ignore","loadError","forEach","_ref2","contentPromise","then","content","rawAttrs","outerHTML","createElement","push","comment","createComment","_ref3","text","crossOrigin","execScript","scriptResult","onload","_objectSpread","scriptOptions","module","crossorigin","crossoriginType","attrs","_sandbox$execQueue","execQueue","execQueueLength","length","requestIdleCallback","shift","_sandbox$execQueue2","getAttribute","findScriptElementFromIframe","rawElement","wujieTag","targetScript","__WUJIE_RAW_DOCUMENT_HEAD__","querySelector","rewriteContains","contains","other","_findScriptElementFro","rewriteRemoveChild","removeChild","child","_findScriptElementFro2","patchEventListener","listenerMap","Map","_cacheListeners","addEventListener","listener","options","listeners","_toConsumableArray","removeEventListener","typeListeners","indexOf","splice","entries","_ref4","_ref5","patchRenderEffect","render","id","body","insertBefore","bind"],"sources":["../src/effect.ts"],"sourcesContent":["import { getExternalStyleSheets, getExternalScripts } from \"./entry\";\nimport {\n  getWujieById,\n  rawAppendChild,\n  rawElementContains,\n  rawElementRemoveChild,\n  rawHeadInsertBefore,\n  rawBodyInsertBefore,\n  rawDocumentQuerySelector,\n  rawAddEventListener,\n  rawRemoveEventListener,\n} from \"./common\";\nimport {\n  isFunction,\n  isHijackingTag,\n  warn,\n  nextTick,\n  getCurUrl,\n  execHooks,\n  isScriptElement,\n  setTagToScript,\n  getTagFromScript,\n  setAttrsToElement,\n} from \"./utils\";\nimport { insertScriptToIframe, patchElementEffect } from \"./iframe\";\nimport Wujie from \"./sandbox\";\nimport { getPatchStyleElements } from \"./shadow\";\nimport { getCssLoader, getEffectLoaders, isMatchUrl } from \"./plugin\";\nimport { WUJIE_SCRIPT_ID, WUJIE_DATA_FLAG, WUJIE_TIPS_REPEAT_RENDER, WUJIE_TIPS_NO_SCRIPT } from \"./constant\";\nimport { ScriptObject, parseTagAttributes } from \"./template\";\n\nfunction patchCustomEvent(\n  e: CustomEvent,\n  elementGetter: () => HTMLScriptElement | HTMLLinkElement | null\n): CustomEvent {\n  Object.defineProperties(e, {\n    srcElement: {\n      get: elementGetter,\n    },\n    target: {\n      get: elementGetter,\n    },\n  });\n\n  return e;\n}\n\n/**\n * 手动触发事件回调\n */\nfunction manualInvokeElementEvent(element: HTMLLinkElement | HTMLScriptElement, event: string): void {\n  const customEvent = new CustomEvent(event);\n  const patchedEvent = patchCustomEvent(customEvent, () => element);\n  if (isFunction(element[`on${event}`])) {\n    element[`on${event}`](patchedEvent);\n  } else {\n    element.dispatchEvent(patchedEvent);\n  }\n}\n\n/**\n * 样式元素的css变量处理，每个stylesheetElement单独节流\n */\nfunction handleStylesheetElementPatch(stylesheetElement: HTMLStyleElement & { _patcher?: any }, sandbox: Wujie) {\n  if (!stylesheetElement.innerHTML || sandbox.degrade) return;\n  const patcher = () => {\n    const [hostStyleSheetElement, fontStyleSheetElement] = getPatchStyleElements([stylesheetElement.sheet]);\n    if (hostStyleSheetElement) {\n      sandbox.shadowRoot.head.appendChild(hostStyleSheetElement);\n    }\n    if (fontStyleSheetElement) {\n      sandbox.shadowRoot.host.appendChild(fontStyleSheetElement);\n    }\n    stylesheetElement._patcher = undefined;\n  };\n  if (stylesheetElement._patcher) {\n    clearTimeout(stylesheetElement._patcher);\n  }\n  stylesheetElement._patcher = setTimeout(patcher, 50);\n}\n\n/**\n * 劫持处理样式元素的属性\n */\nfunction patchStylesheetElement(\n  stylesheetElement: HTMLStyleElement & { _hasPatchStyle?: boolean },\n  cssLoader: (code: string, url: string, base: string) => string,\n  sandbox: Wujie,\n  curUrl: string\n) {\n  if (stylesheetElement._hasPatchStyle) return;\n  const innerHTMLDesc = Object.getOwnPropertyDescriptor(Element.prototype, \"innerHTML\");\n  const innerTextDesc = Object.getOwnPropertyDescriptor(HTMLElement.prototype, \"innerText\");\n  const textContentDesc = Object.getOwnPropertyDescriptor(Node.prototype, \"textContent\");\n  const RawInsertRule = stylesheetElement.sheet?.insertRule;\n  // 这个地方将cssRule加到innerHTML中去，防止子应用切换之后丢失\n  function patchSheetInsertRule() {\n    if (!RawInsertRule) return;\n    stylesheetElement.sheet.insertRule = (rule: string, index?: number): number => {\n      innerHTMLDesc ? (stylesheetElement.innerHTML += rule) : (stylesheetElement.innerText += rule);\n      return RawInsertRule.call(stylesheetElement.sheet, rule, index);\n    };\n  }\n  patchSheetInsertRule();\n\n  if (innerHTMLDesc) {\n    Object.defineProperties(stylesheetElement, {\n      innerHTML: {\n        get: function () {\n          return innerHTMLDesc.get.call(stylesheetElement);\n        },\n        set: function (code: string) {\n          innerHTMLDesc.set.call(stylesheetElement, cssLoader(code, \"\", curUrl));\n          nextTick(() => handleStylesheetElementPatch(this, sandbox));\n        },\n      },\n    });\n  }\n\n  Object.defineProperties(stylesheetElement, {\n    innerText: {\n      get: function () {\n        return innerTextDesc.get.call(stylesheetElement);\n      },\n      set: function (code: string) {\n        innerTextDesc.set.call(stylesheetElement, cssLoader(code, \"\", curUrl));\n        nextTick(() => handleStylesheetElementPatch(this, sandbox));\n      },\n    },\n    textContent: {\n      get: function () {\n        return textContentDesc.get.call(stylesheetElement);\n      },\n      set: function (code: string) {\n        textContentDesc.set.call(stylesheetElement, cssLoader(code, \"\", curUrl));\n        nextTick(() => handleStylesheetElementPatch(this, sandbox));\n      },\n    },\n    appendChild: {\n      value: function (node: Node): Node {\n        nextTick(() => handleStylesheetElementPatch(this, sandbox));\n        if (node.nodeType === Node.TEXT_NODE) {\n          const res = rawAppendChild.call(\n            stylesheetElement,\n            stylesheetElement.ownerDocument.createTextNode(cssLoader(node.textContent, \"\", curUrl))\n          );\n          // 当appendChild之后，样式元素的sheet对象发生改变，要重新patch\n          patchSheetInsertRule();\n          return res;\n        } else return rawAppendChild(node);\n      },\n    },\n    _hasPatchStyle: { get: () => true },\n  });\n}\n\nlet dynamicScriptExecStack = Promise.resolve();\nfunction rewriteAppendOrInsertChild(opts: {\n  rawDOMAppendOrInsertBefore: <T extends Node>(newChild: T, refChild?: Node | null) => T;\n  wujieId: string;\n}) {\n  return function appendChildOrInsertBefore<T extends Node>(\n    this: HTMLHeadElement | HTMLBodyElement,\n    newChild: T,\n    refChild?: Node | null\n  ) {\n    let element = newChild as any;\n    const { rawDOMAppendOrInsertBefore, wujieId } = opts;\n    const sandbox = getWujieById(wujieId);\n\n    const { styleSheetElements, replace, fetch, plugins, iframe, lifecycles, proxyLocation, fiber } = sandbox;\n\n    if (!isHijackingTag(element.tagName) || !wujieId) {\n      const res = rawDOMAppendOrInsertBefore.call(this, element, refChild) as T;\n      patchElementEffect(element, iframe.contentWindow);\n      execHooks(plugins, \"appendOrInsertElementHook\", element, iframe.contentWindow);\n      return res;\n    }\n\n    const iframeDocument = iframe.contentDocument;\n    const curUrl = getCurUrl(proxyLocation);\n\n    // TODO 过滤可以开放\n    if (element.tagName) {\n      switch (element.tagName?.toUpperCase()) {\n        case \"LINK\": {\n          const { href, rel, type } = element as HTMLLinkElement;\n          const styleFlag = rel === \"stylesheet\" || type === \"text/css\" || href.endsWith(\".css\");\n          // 非 stylesheet 不做处理\n          if (!styleFlag) {\n            const res = rawDOMAppendOrInsertBefore.call(this, element, refChild);\n            execHooks(plugins, \"appendOrInsertElementHook\", element, iframe.contentWindow);\n            return res;\n          }\n          // 排除css\n          if (href && !isMatchUrl(href, getEffectLoaders(\"cssExcludes\", plugins))) {\n            getExternalStyleSheets(\n              [{ src: href, ignore: isMatchUrl(href, getEffectLoaders(\"cssIgnores\", plugins)) }],\n              fetch,\n              lifecycles.loadError\n            ).forEach(({ src, ignore, contentPromise }) =>\n              contentPromise.then(\n                (content) => {\n                  // 处理 ignore 样式\n                  const rawAttrs = parseTagAttributes(element.outerHTML);\n                  if (ignore && src) {\n                    // const stylesheetElement = iframeDocument.createElement(\"link\");\n                    // const attrs = {\n                    //   ...rawAttrs,\n                    //   type: \"text/css\",\n                    //   rel: \"stylesheet\",\n                    //   href: src,\n                    // };\n                    // setAttrsToElement(stylesheetElement, attrs);\n                    // rawDOMAppendOrInsertBefore.call(this, stylesheetElement, refChild);\n                    // manualInvokeElementEvent(element, \"load\");\n                    // 忽略的元素应该直接把对应元素插入，而不是用新的 link 标签进行替代插入，保证 element 的上下文正常\n                    rawDOMAppendOrInsertBefore.call(this, element, refChild);\n                  } else {\n                    // 记录js插入样式，子应用重新激活时恢复\n                    const stylesheetElement = iframeDocument.createElement(\"style\");\n                    // 处理css-loader插件\n                    const cssLoader = getCssLoader({ plugins, replace });\n                    stylesheetElement.innerHTML = cssLoader(content, src, curUrl);\n                    styleSheetElements.push(stylesheetElement);\n                    setAttrsToElement(stylesheetElement, rawAttrs);\n                    rawDOMAppendOrInsertBefore.call(this, stylesheetElement, refChild);\n                    // 处理样式补丁\n                    handleStylesheetElementPatch(stylesheetElement, sandbox);\n                    manualInvokeElementEvent(element, \"load\");\n                  }\n                  element = null;\n                },\n                () => {\n                  manualInvokeElementEvent(element, \"error\");\n                  element = null;\n                }\n              )\n            );\n          }\n\n          const comment = iframeDocument.createComment(`dynamic link ${href} replaced by wujie`);\n          return rawDOMAppendOrInsertBefore.call(this, comment, refChild);\n        }\n        case \"STYLE\": {\n          const stylesheetElement: HTMLStyleElement = newChild as any;\n          styleSheetElements.push(stylesheetElement);\n          const content = stylesheetElement.innerHTML;\n          const cssLoader = getCssLoader({ plugins, replace });\n          content && (stylesheetElement.innerHTML = cssLoader(content, \"\", curUrl));\n          const res = rawDOMAppendOrInsertBefore.call(this, element, refChild);\n          // 处理样式补丁\n          patchStylesheetElement(stylesheetElement, cssLoader, sandbox, curUrl);\n          handleStylesheetElementPatch(stylesheetElement, sandbox);\n          execHooks(plugins, \"appendOrInsertElementHook\", element, iframe.contentWindow);\n          return res;\n        }\n        case \"SCRIPT\": {\n          setTagToScript(element);\n          const { src, text, type, crossOrigin } = element as HTMLScriptElement;\n          // 排除js\n          if (src && !isMatchUrl(src, getEffectLoaders(\"jsExcludes\", plugins))) {\n            const execScript = (scriptResult: ScriptObject) => {\n              // 假如子应用被连续渲染两次，两次渲染会导致处理流程的交叉污染\n              if (sandbox.iframe === null) return warn(WUJIE_TIPS_REPEAT_RENDER);\n              const onload = () => {\n                manualInvokeElementEvent(element, \"load\");\n                element = null;\n              };\n              insertScriptToIframe({ ...scriptResult, onload }, sandbox.iframe.contentWindow, element);\n            };\n            const scriptOptions = {\n              src,\n              module: type === \"module\",\n              crossorigin: crossOrigin !== null,\n              crossoriginType: crossOrigin || \"\",\n              ignore: isMatchUrl(src, getEffectLoaders(\"jsIgnores\", plugins)),\n              attrs: parseTagAttributes(element.outerHTML),\n            } as ScriptObject;\n            getExternalScripts([scriptOptions], fetch, lifecycles.loadError, fiber).forEach((scriptResult) => {\n              dynamicScriptExecStack = dynamicScriptExecStack.then(() =>\n                scriptResult.contentPromise.then(\n                  (content) => {\n                    if (sandbox.execQueue === null) return warn(WUJIE_TIPS_REPEAT_RENDER);\n                    const execQueueLength = sandbox.execQueue?.length;\n                    sandbox.execQueue.push(() =>\n                      fiber\n                        ? sandbox.requestIdleCallback(() => {\n                            execScript({ ...scriptResult, content });\n                          })\n                        : execScript({ ...scriptResult, content })\n                    );\n                    // 同步脚本如果都执行完了，需要手动触发执行\n                    if (!execQueueLength) sandbox.execQueue.shift()();\n                  },\n                  () => {\n                    manualInvokeElementEvent(element, \"error\");\n                    element = null;\n                  }\n                )\n              );\n            });\n          } else {\n            const execQueueLength = sandbox.execQueue?.length;\n            sandbox.execQueue.push(() =>\n              fiber\n                ? sandbox.requestIdleCallback(() => {\n                    insertScriptToIframe(\n                      { src: null, content: text, attrs: parseTagAttributes(element.outerHTML) },\n                      sandbox.iframe.contentWindow,\n                      element\n                    );\n                  })\n                : insertScriptToIframe(\n                    { src: null, content: text, attrs: parseTagAttributes(element.outerHTML) },\n                    sandbox.iframe.contentWindow,\n                    element\n                  )\n            );\n            if (!execQueueLength) sandbox.execQueue.shift()();\n          }\n          // inline script never trigger the onload and onerror event\n          const comment = iframeDocument.createComment(`dynamic script ${src} replaced by wujie`);\n          return rawDOMAppendOrInsertBefore.call(this, comment, refChild);\n        }\n        // 修正子应用内部iframe的window.parent指向\n        case \"IFRAME\": {\n          // 嵌套的子应用的js-iframe需要插入子应用的js-iframe内部\n          if (element.getAttribute(WUJIE_DATA_FLAG) === \"\") {\n            return rawAppendChild.call(rawDocumentQuerySelector.call(this.ownerDocument, \"html\"), element);\n          }\n          const res = rawDOMAppendOrInsertBefore.call(this, element, refChild);\n          execHooks(plugins, \"appendOrInsertElementHook\", element, iframe.contentWindow);\n          return res;\n        }\n        default:\n      }\n    }\n  };\n}\n\nfunction findScriptElementFromIframe(rawElement: HTMLScriptElement, wujieId: string) {\n  const wujieTag = getTagFromScript(rawElement);\n  const sandbox = getWujieById(wujieId);\n  const { iframe } = sandbox;\n  const targetScript = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_HEAD__.querySelector(\n    `script[${WUJIE_SCRIPT_ID}='${wujieTag}']`\n  );\n  if (targetScript === null) {\n    warn(WUJIE_TIPS_NO_SCRIPT, `<script ${WUJIE_SCRIPT_ID}='${wujieTag}'/>`);\n  }\n  return { targetScript, iframe };\n}\n\nfunction rewriteContains(opts: { rawElementContains: (other: Node | null) => boolean; wujieId: string }) {\n  return function contains(other: Node | null) {\n    const element = other as HTMLElement;\n    const { rawElementContains, wujieId } = opts;\n    if (element && isScriptElement(element)) {\n      const { targetScript } = findScriptElementFromIframe(element as HTMLScriptElement, wujieId);\n      return targetScript !== null;\n    }\n    return rawElementContains(element);\n  };\n}\n\nfunction rewriteRemoveChild(opts: { rawElementRemoveChild: <T extends Node>(child: T) => T; wujieId: string }) {\n  return function removeChild(child: Node) {\n    const element = child as HTMLElement;\n    const { rawElementRemoveChild, wujieId } = opts;\n    if (element && isScriptElement(element)) {\n      const { targetScript, iframe } = findScriptElementFromIframe(element as HTMLScriptElement, wujieId);\n      if (targetScript !== null) {\n        return iframe.contentWindow.__WUJIE_RAW_DOCUMENT_HEAD__.removeChild(targetScript);\n      }\n      return null;\n    }\n    return rawElementRemoveChild(element);\n  };\n}\n\n/**\n * 记录head和body的事件，等重新渲染复用head和body时需要清空事件\n */\nfunction patchEventListener(element: HTMLHeadElement | HTMLBodyElement) {\n  const listenerMap = new Map<string, EventListenerOrEventListenerObject[]>();\n  element._cacheListeners = listenerMap;\n\n  element.addEventListener = (\n    type: string,\n    listener: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ) => {\n    const listeners = listenerMap.get(type) || [];\n    listenerMap.set(type, [...listeners, listener]);\n    return rawAddEventListener.call(element, type, listener, options);\n  };\n\n  element.removeEventListener = (\n    type: string,\n    listener: EventListenerOrEventListenerObject,\n    options?: boolean | AddEventListenerOptions\n  ) => {\n    const typeListeners = listenerMap.get(type);\n    const index = typeListeners?.indexOf(listener);\n    if (typeListeners?.length && index !== -1) {\n      typeListeners.splice(index, 1);\n    }\n    return rawRemoveEventListener.call(element, type, listener, options);\n  };\n}\n\n/**\n * 清空head和body的绑定的事件\n */\nexport function removeEventListener(element: HTMLHeadElement | HTMLBodyElement) {\n  const listenerMap = element._cacheListeners;\n  [...listenerMap.entries()].forEach(([type, listeners]) => {\n    listeners.forEach((listener) => rawRemoveEventListener.call(element, type, listener));\n  });\n}\n\n/**\n * patch head and body in render\n * intercept appendChild and insertBefore\n */\nexport function patchRenderEffect(render: ShadowRoot | Document, id: string, degrade: boolean): void {\n  // 降级场景dom渲染在iframe中，iframe移动后事件自动销毁，不需要记录\n  if (!degrade) {\n    patchEventListener(render.head);\n    patchEventListener(render.body as HTMLBodyElement);\n  }\n\n  render.head.appendChild = rewriteAppendOrInsertChild({\n    rawDOMAppendOrInsertBefore: rawAppendChild,\n    wujieId: id,\n  }) as typeof rawAppendChild;\n  render.head.insertBefore = rewriteAppendOrInsertChild({\n    rawDOMAppendOrInsertBefore: rawHeadInsertBefore as any,\n    wujieId: id,\n  }) as typeof rawHeadInsertBefore;\n  render.head.removeChild = rewriteRemoveChild({\n    rawElementRemoveChild: rawElementRemoveChild.bind(render.head),\n    wujieId: id,\n  }) as typeof rawElementRemoveChild;\n  render.head.contains = rewriteContains({\n    rawElementContains: rawElementContains.bind(render.head),\n    wujieId: id,\n  }) as typeof rawElementContains;\n  render.contains = rewriteContains({\n    rawElementContains: rawElementContains.bind(render),\n    wujieId: id,\n  }) as typeof rawElementContains;\n  render.body.appendChild = rewriteAppendOrInsertChild({\n    rawDOMAppendOrInsertBefore: rawAppendChild,\n    wujieId: id,\n  }) as typeof rawAppendChild;\n  render.body.insertBefore = rewriteAppendOrInsertChild({\n    rawDOMAppendOrInsertBefore: rawBodyInsertBefore as any,\n    wujieId: id,\n  }) as typeof rawBodyInsertBefore;\n}\n"],"mappings":"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"}