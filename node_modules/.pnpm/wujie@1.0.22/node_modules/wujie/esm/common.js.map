{"version":3,"file":"common.js","names":["idToSandboxCacheMap","window","__POWERED_BY_WUJIE__","__WUJIE","inject","idToSandboxMap","Map","getWujieById","id","_idToSandboxCacheMap$","get","wujie","getOptionsById","_idToSandboxCacheMap$2","options","addSandboxCacheWithWujie","sandbox","wujieCache","set","_objectSpread","deleteWujieById","addSandboxCacheWithOptions","documentProxyProperties","modifyLocalProperties","modifyProperties","shadowProperties","shadowMethods","documentProperties","documentMethods","documentEvents","ownerProperties","appDocumentAddEventListenerEvents","appDocumentOnEvents","mainDocumentAddEventListenerEvents","mainAndAppAddEventListenerEvents","appWindowAddEventListenerEvents","appWindowOnEvent","relativeElementTagAttrMap","IMG","A","SOURCE","windowProxyProperties","windowRegWhiteList","rawElementAppendChild","HTMLElement","prototype","appendChild","rawElementRemoveChild","removeChild","rawElementContains","contains","rawHeadInsertBefore","HTMLHeadElement","insertBefore","rawBodyInsertBefore","HTMLBodyElement","rawAddEventListener","Node","addEventListener","rawRemoveEventListener","removeEventListener","rawWindowAddEventListener","rawWindowRemoveEventListener","rawAppendChild","rawDocumentQuerySelector","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__","Document","querySelector"],"sources":["../src/common.ts"],"sourcesContent":["import Wujie from \"./sandbox\";\nimport { cacheOptions } from \"./index\";\nexport interface SandboxCache {\n  wujie?: Wujie;\n  options?: cacheOptions;\n}\n\nexport type appAddEventListenerOptions = AddEventListenerOptions & { targetWindow?: Window };\n\n// 全部无界实例和配置存储map\nexport const idToSandboxCacheMap = window.__POWERED_BY_WUJIE__\n  ? window.__WUJIE.inject.idToSandboxMap\n  : new Map<String, SandboxCache>();\n\nexport function getWujieById(id: String): Wujie | null {\n  return idToSandboxCacheMap.get(id)?.wujie || null;\n}\n\nexport function getOptionsById(id: String): cacheOptions | null {\n  return idToSandboxCacheMap.get(id)?.options || null;\n}\n\nexport function addSandboxCacheWithWujie(id: string, sandbox: Wujie): void {\n  const wujieCache = idToSandboxCacheMap.get(id);\n  if (wujieCache) idToSandboxCacheMap.set(id, { ...wujieCache, wujie: sandbox });\n  else idToSandboxCacheMap.set(id, { wujie: sandbox });\n}\n\nexport function deleteWujieById(id: string) {\n  const wujieCache = idToSandboxCacheMap.get(id);\n  if (wujieCache?.options) idToSandboxCacheMap.set(id, { options: wujieCache.options });\n  idToSandboxCacheMap.delete(id);\n}\n\nexport function addSandboxCacheWithOptions(id: string, options: cacheOptions): void {\n  const wujieCache = idToSandboxCacheMap.get(id);\n  if (wujieCache) idToSandboxCacheMap.set(id, { ...wujieCache, options });\n  else idToSandboxCacheMap.set(id, { options });\n}\n\n// 分类document上需要处理的属性，不同类型会进入不同的处理逻辑\nexport const documentProxyProperties = {\n  // 降级场景下需要本地特殊处理的属性\n  modifyLocalProperties: [\"createElement\", \"createTextNode\", \"documentURI\", \"URL\", \"getElementsByTagName\"],\n\n  // 子应用需要手动修正的属性方法\n  modifyProperties: [\n    \"createElement\",\n    \"createTextNode\",\n    \"documentURI\",\n    \"URL\",\n    \"getElementsByTagName\",\n    \"getElementsByClassName\",\n    \"getElementsByName\",\n    \"getElementById\",\n    \"querySelector\",\n    \"querySelectorAll\",\n    \"documentElement\",\n    \"scrollingElement\",\n    \"forms\",\n    \"images\",\n    \"links\",\n  ],\n\n  // 需要从shadowRoot中获取的属性\n  shadowProperties: [\n    \"activeElement\",\n    \"childElementCount\",\n    \"children\",\n    \"firstElementChild\",\n    \"firstChild\",\n    \"fullscreenElement\",\n    \"lastElementChild\",\n    \"pictureInPictureElement\",\n    \"pointerLockElement\",\n    \"styleSheets\",\n  ],\n\n  // 需要从shadowRoot中获取的方法\n  shadowMethods: [\n    \"append\",\n    \"contains\",\n    \"getSelection\",\n    \"elementFromPoint\",\n    \"elementsFromPoint\",\n    \"getAnimations\",\n    \"replaceChildren\",\n  ],\n\n  // 需要从主应用document中获取的属性\n  documentProperties: [\n    \"characterSet\",\n    \"compatMode\",\n    \"contentType\",\n    \"designMode\",\n    \"dir\",\n    \"doctype\",\n    \"embeds\",\n    \"fullscreenEnabled\",\n    \"hidden\",\n    \"implementation\",\n    \"lastModified\",\n    \"pictureInPictureEnabled\",\n    \"plugins\",\n    \"readyState\",\n    \"referrer\",\n    \"visibilityState\",\n    \"fonts\",\n  ],\n\n  // 需要从主应用document中获取的方法\n  documentMethods: [\n    \"execCommand\",\n    \"caretPositionFromPoint\",\n    \"createRange\",\n    \"exitFullscreen\",\n    \"exitPictureInPicture\",\n    \"getElementsByTagNameNS\",\n    \"hasFocus\",\n    \"prepend\",\n  ],\n\n  // 需要从主应用document中获取的事件\n  documentEvents: [\n    \"onpointerlockchange\",\n    \"onpointerlockerror\",\n    \"onbeforecopy\",\n    \"onbeforecut\",\n    \"onbeforepaste\",\n    \"onfreeze\",\n    \"onresume\",\n    \"onsearch\",\n    \"onfullscreenchange\",\n    \"onfullscreenerror\",\n    \"onsecuritypolicyviolation\",\n    \"onvisibilitychange\",\n  ],\n\n  // 无需修改原型的属性\n  ownerProperties: [\"head\", \"body\"],\n};\n\n// 需要挂载到子应用iframe document上的事件\nexport const appDocumentAddEventListenerEvents = [\"DOMContentLoaded\", \"readystatechange\"];\nexport const appDocumentOnEvents = [\"onreadystatechange\"];\n// 需要挂载到主应用document上的事件\nexport const mainDocumentAddEventListenerEvents = [\n  \"fullscreenchange\",\n  \"fullscreenerror\",\n  \"selectionchange\",\n  \"visibilitychange\",\n  \"wheel\",\n  \"keydown\",\n  \"keypress\",\n  \"keyup\",\n];\n\n// 需要同时挂载到主应用document和shadow上的事件（互斥）\nexport const mainAndAppAddEventListenerEvents = [\"gotpointercapture\", \"lostpointercapture\"];\n\n// 子应用window监听需要挂载到iframe沙箱上的事件\nexport const appWindowAddEventListenerEvents = [\n  \"hashchange\",\n  \"popstate\",\n  \"DOMContentLoaded\",\n  \"load\",\n  \"beforeunload\",\n  \"unload\",\n  \"message\",\n  \"error\",\n  \"unhandledrejection\",\n];\n\n// 子应用window.onXXX需要挂载到iframe沙箱上的事件\nexport const appWindowOnEvent = [\"onload\", \"onbeforeunload\", \"onunload\"];\n\n// 相对路径问题元素的tag和attr的map\nexport const relativeElementTagAttrMap = {\n  IMG: \"src\",\n  A: \"href\",\n  SOURCE: \"src\",\n};\n\n// 需要单独处理的window属性\nexport const windowProxyProperties = [\"getComputedStyle\", \"visualViewport\", \"matchMedia\", \"DOMParser\"];\n\n// window白名单\nexport const windowRegWhiteList = [\n  /animationFrame$/i,\n  /resizeObserver$|mutationObserver$|intersectionObserver$/i,\n  /height$|width$|left$/i,\n  /^screen/i,\n  /X$|Y$/,\n];\n\n// 保存原型方法\n// 子应用的Document.prototype已经被改写了\nexport const rawElementAppendChild = HTMLElement.prototype.appendChild;\nexport const rawElementRemoveChild = HTMLElement.prototype.removeChild;\nexport const rawElementContains = HTMLElement.prototype.contains;\nexport const rawHeadInsertBefore = HTMLHeadElement.prototype.insertBefore;\nexport const rawBodyInsertBefore = HTMLBodyElement.prototype.insertBefore;\nexport const rawAddEventListener = Node.prototype.addEventListener;\nexport const rawRemoveEventListener = Node.prototype.removeEventListener;\nexport const rawWindowAddEventListener = window.addEventListener;\nexport const rawWindowRemoveEventListener = window.removeEventListener;\nexport const rawAppendChild = Node.prototype.appendChild;\nexport const rawDocumentQuerySelector = window.__POWERED_BY_WUJIE__\n  ? window.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\n  : Document.prototype.querySelector;\n"],"mappings":"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"}