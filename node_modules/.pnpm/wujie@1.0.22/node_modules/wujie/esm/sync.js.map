{"version":3,"file":"sync.js","names":["anchorElementGenerator","getAnchorElementQueryMap","getSyncUrl","appRouteParse","getDegradeIframe","renderIframeReplaceApp","patchEventTimeStamp","renderElementToContainer","initRenderIframeAndContainer","getWujieById","rawDocumentQuerySelector","syncUrlToWindow","iframeWindow","_iframeWindow$__WUJIE","__WUJIE","sync","id","prefix","winUrlElement","window","location","href","queryMap","curUrl","pathname","search","hash","validShortPath","Object","keys","forEach","shortPath","longPath","startsWith","length","encodeURIComponent","replace","concat","newQuery","map","key","join","history","replaceState","syncUrlToIframe","_iframeWindow$locatio","_iframeWindow$__WUJIE2","url","execFlag","inject","idUrl","syncUrl","test","_appRouteParse","appRoutePath","preAppRoutePath","mainHostPath","clearInactiveAppUrl","sandbox","hrefFlag","activeFlag","pushUrlToWindow","pushState","processAppForHrefJump","addEventListener","filter","iframeBody","call","iframe","contentDocument","degrade","document","documentElement","decodeURIComponent","parentElement","degradeAttrs","shadowRoot","host","_initRenderIframeAndC","el","contentWindow","onunload","unmount","appendChild","firstElementChild"],"sources":["../src/sync.ts"],"sourcesContent":["import { anchorElementGenerator, getAnchorElementQueryMap, getSyncUrl, appRouteParse, getDegradeIframe } from \"./utils\";\nimport { renderIframeReplaceApp, patchEventTimeStamp } from \"./iframe\";\nimport { renderElementToContainer, initRenderIframeAndContainer } from \"./shadow\";\nimport { getWujieById, rawDocumentQuerySelector } from \"./common\";\n\n/**\n * 同步子应用路由到主应用路由\n */\nexport function syncUrlToWindow(iframeWindow: Window): void {\n  const { sync, id, prefix } = iframeWindow.__WUJIE;\n  let winUrlElement = anchorElementGenerator(window.location.href);\n  const queryMap = getAnchorElementQueryMap(winUrlElement);\n  // 非同步且url上没有当前id的查询参数，否则就要同步参数或者清理参数\n  if (!sync && !queryMap[id]) return (winUrlElement = null);\n  const curUrl = iframeWindow.location.pathname + iframeWindow.location.search + iframeWindow.location.hash;\n  let validShortPath = \"\";\n  // 处理短路径\n  if (prefix) {\n    Object.keys(prefix).forEach((shortPath) => {\n      const longPath = prefix[shortPath];\n      // 找出最长匹配路径\n      if (curUrl.startsWith(longPath) && (!validShortPath || longPath.length > prefix[validShortPath].length)) {\n        validShortPath = shortPath;\n      }\n    });\n  }\n  // 同步\n  if (sync) {\n    queryMap[id] = window.encodeURIComponent(\n      validShortPath ? curUrl.replace(prefix[validShortPath], `{${validShortPath}}`) : curUrl\n    );\n    // 清理\n  } else {\n    delete queryMap[id];\n  }\n  const newQuery =\n    \"?\" +\n    Object.keys(queryMap)\n      .map((key) => key + \"=\" + queryMap[key])\n      .join(\"&\");\n  winUrlElement.search = newQuery;\n  if (winUrlElement.href !== window.location.href) {\n    window.history.replaceState(null, \"\", winUrlElement.href);\n  }\n  winUrlElement = null;\n}\n\n/**\n * 同步主应用路由到子应用\n */\nexport function syncUrlToIframe(iframeWindow: Window): void {\n  // 获取当前路由路径\n  const { pathname, search, hash } = iframeWindow.location;\n  const { id, url, sync, execFlag, prefix, inject } = iframeWindow.__WUJIE;\n\n  // 只在浏览器刷新或者第一次渲染时同步\n  const idUrl = sync && !execFlag ? getSyncUrl(id, prefix) : url;\n  // 排除href跳转情况\n  const syncUrl = (/^http/.test(idUrl) ? null : idUrl) || url;\n  const { appRoutePath } = appRouteParse(syncUrl);\n\n  const preAppRoutePath = pathname + search + hash;\n  if (preAppRoutePath !== appRoutePath) {\n    iframeWindow.history.replaceState(null, \"\", inject.mainHostPath + appRoutePath);\n  }\n}\n\n/**\n * 清理非激活态的子应用同步参数\n * 主应用采用hash模式时，切换子应用后已销毁的子应用同步参数还存在需要手动清理\n */\nexport function clearInactiveAppUrl(): void {\n  let winUrlElement = anchorElementGenerator(window.location.href);\n  const queryMap = getAnchorElementQueryMap(winUrlElement);\n  Object.keys(queryMap).forEach((id) => {\n    const sandbox = getWujieById(id);\n    if (!sandbox) return;\n    // 子应用执行过并且已经失活才需要清除\n    if (sandbox.execFlag && sandbox.sync && !sandbox.hrefFlag && !sandbox.activeFlag) {\n      delete queryMap[id];\n    }\n  });\n  const newQuery =\n    \"?\" +\n    Object.keys(queryMap)\n      .map((key) => key + \"=\" + queryMap[key])\n      .join(\"&\");\n  winUrlElement.search = newQuery;\n  if (winUrlElement.href !== window.location.href) {\n    window.history.replaceState(null, \"\", winUrlElement.href);\n  }\n  winUrlElement = null;\n}\n\n/**\n * 推送指定url到主应用路由\n */\nexport function pushUrlToWindow(id: string, url: string): void {\n  let winUrlElement = anchorElementGenerator(window.location.href);\n  const queryMap = getAnchorElementQueryMap(winUrlElement);\n  queryMap[id] = window.encodeURIComponent(url);\n  const newQuery =\n    \"?\" +\n    Object.keys(queryMap)\n      .map((key) => key + \"=\" + queryMap[key])\n      .join(\"&\");\n  winUrlElement.search = newQuery;\n  window.history.pushState(null, \"\", winUrlElement.href);\n  winUrlElement = null;\n}\n\n/**\n * 应用跳转(window.location.href)情况路由处理\n */\nexport function processAppForHrefJump(): void {\n  window.addEventListener(\"popstate\", () => {\n    let winUrlElement = anchorElementGenerator(window.location.href);\n    const queryMap = getAnchorElementQueryMap(winUrlElement);\n    winUrlElement = null;\n    Object.keys(queryMap)\n      .map((id) => getWujieById(id))\n      .filter((sandbox) => sandbox)\n      .forEach((sandbox) => {\n        const url = queryMap[sandbox.id];\n        const iframeBody = rawDocumentQuerySelector.call(sandbox.iframe.contentDocument, \"body\");\n        // 前进href\n        if (/http/.test(url)) {\n          if (sandbox.degrade) {\n            renderElementToContainer(sandbox.document.documentElement, iframeBody);\n            renderIframeReplaceApp(\n              window.decodeURIComponent(url),\n              getDegradeIframe(sandbox.id).parentElement,\n              sandbox.degradeAttrs\n            );\n          } else\n            renderIframeReplaceApp(\n              window.decodeURIComponent(url),\n              sandbox.shadowRoot.host.parentElement,\n              sandbox.degradeAttrs\n            );\n          sandbox.hrefFlag = true;\n          // href后退\n        } else if (sandbox.hrefFlag) {\n          if (sandbox.degrade) {\n            // 走全套流程，但是事件恢复不需要\n            const { iframe } = initRenderIframeAndContainer(sandbox.id, sandbox.el, sandbox.degradeAttrs);\n            patchEventTimeStamp(iframe.contentWindow, sandbox.iframe.contentWindow);\n            iframe.contentWindow.onunload = () => {\n              sandbox.unmount();\n            };\n            iframe.contentDocument.appendChild(iframeBody.firstElementChild);\n            sandbox.document = iframe.contentDocument;\n          } else renderElementToContainer(sandbox.shadowRoot.host, sandbox.el);\n          sandbox.hrefFlag = false;\n        }\n      });\n  });\n}\n"],"mappings":"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"}