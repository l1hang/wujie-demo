{"version":3,"file":"proxy.js","names":["patchElementEffect","renderIframeReplaceApp","renderElementToContainer","pushUrlToWindow","documentProxyProperties","rawDocumentQuerySelector","WUJIE_TIPS_RELOAD_DISABLED","WUJIE_TIPS_GET_ELEMENT_BY_ID","getTargetValue","anchorElementGenerator","getDegradeIframe","isCallable","checkProxyFunction","warn","stopMainAppRun","locationHrefSet","iframe","value","appHostPath","_iframe$contentWindow","contentWindow","__WUJIE","shadowRoot","id","degrade","document","degradeAttrs","url","test","hrefElement","pathname","search","hash","hrefFlag","iframeBody","call","contentDocument","documentElement","window","decodeURIComponent","parentElement","host","proxyGenerator","urlElement","mainHostPath","proxyWindow","Proxy","get","target","p","proxyLocation","Object","getOwnPropertyDescriptor","proxy","descriptor","configurable","writable","set","has","proxyDocument","_fakeDocument","propKey","_iframe$contentWindow2","rawCreateElement","__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__","rawCreateTextNode","__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__","apply","_createElement","_ctx","args","rawCreateMethod","element","href","querySelectorAll","arg","scripts","concat","res","error","querySelector","ctx","_ctx$propKey","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__","rawPropMap","_ctx$propKey2","firstElementChild","ownerProperties","shadowProperties","shadowMethods","documentProperties","documentMethods","includes","toString","activeElement","body","_getTargetValue","_fakeLocation","location","replace","_args$","ownKeys","keys","filter","key","_target","enumerable","localGenerator","sandbox","defineProperties","createElement","_len","arguments","length","Array","_key","createTextNode","_len2","_key2","documentURI","URL","getElementsByTagName","tagName","undefined","modifyLocalProperties","modifyProperties","forEach","defineProperty","_sandbox$document","bind","locationKeys","constantKey","reload"],"sources":["../src/proxy.ts"],"sourcesContent":["import { patchElementEffect, renderIframeReplaceApp } from \"./iframe\";\nimport { renderElementToContainer } from \"./shadow\";\nimport { pushUrlToWindow } from \"./sync\";\nimport { documentProxyProperties, rawDocumentQuerySelector } from \"./common\";\nimport { WUJIE_TIPS_RELOAD_DISABLED, WUJIE_TIPS_GET_ELEMENT_BY_ID } from \"./constant\";\nimport {\n  getTargetValue,\n  anchorElementGenerator,\n  getDegradeIframe,\n  isCallable,\n  checkProxyFunction,\n  warn,\n  stopMainAppRun,\n} from \"./utils\";\n\n/**\n * location href 的set劫持操作\n */\nfunction locationHrefSet(iframe: HTMLIFrameElement, value: string, appHostPath: string): boolean {\n  const { shadowRoot, id, degrade, document, degradeAttrs } = iframe.contentWindow.__WUJIE;\n  let url = value;\n  if (!/^http/.test(url)) {\n    let hrefElement = anchorElementGenerator(url);\n    url = appHostPath + hrefElement.pathname + hrefElement.search + hrefElement.hash;\n    hrefElement = null;\n  }\n  iframe.contentWindow.__WUJIE.hrefFlag = true;\n  if (degrade) {\n    const iframeBody = rawDocumentQuerySelector.call(iframe.contentDocument, \"body\");\n    renderElementToContainer(document.documentElement, iframeBody);\n    renderIframeReplaceApp(window.decodeURIComponent(url), getDegradeIframe(id).parentElement, degradeAttrs);\n  } else renderIframeReplaceApp(url, shadowRoot.host.parentElement, degradeAttrs);\n  pushUrlToWindow(id, url);\n  return true;\n}\n\n/**\n * 非降级情况下window、document、location代理\n */\nexport function proxyGenerator(\n  iframe: HTMLIFrameElement,\n  urlElement: HTMLAnchorElement,\n  mainHostPath: string,\n  appHostPath: string\n): {\n  proxyWindow: Window;\n  proxyDocument: Object;\n  proxyLocation: Object;\n} {\n  const proxyWindow = new Proxy(iframe.contentWindow, {\n    get: (target: Window, p: PropertyKey): any => {\n      // location进行劫持\n      if (p === \"location\") {\n        return target.__WUJIE.proxyLocation;\n      }\n      // 判断自身\n      if (p === \"self\" || (p === \"window\" && Object.getOwnPropertyDescriptor(window, \"window\").get)) {\n        return target.__WUJIE.proxy;\n      }\n      // 不要绑定this\n      if (p === \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\" || p === \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__\") {\n        return target[p];\n      }\n      // https://262.ecma-international.org/8.0/#sec-proxy-object-internal-methods-and-internal-slots-get-p-receiver\n      const descriptor = Object.getOwnPropertyDescriptor(target, p);\n      if (descriptor?.configurable === false && descriptor?.writable === false) {\n        return target[p];\n      }\n      // 修正this指针指向\n      return getTargetValue(target, p);\n    },\n\n    set: (target: Window, p: PropertyKey, value: any) => {\n      checkProxyFunction(value);\n      target[p] = value;\n      return true;\n    },\n\n    has: (target: Window, p: PropertyKey) => p in target,\n  });\n\n  // proxy document\n  const proxyDocument = new Proxy(\n    {},\n    {\n      get: function (_fakeDocument, propKey) {\n        const document = window.document;\n        const { shadowRoot, proxyLocation } = iframe.contentWindow.__WUJIE;\n        // iframe初始化完成后，webcomponent还未挂在上去，此时运行了主应用代码，必须中止\n        if (!shadowRoot) stopMainAppRun();\n        const rawCreateElement = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__;\n        const rawCreateTextNode = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__;\n        // need fix\n        if (propKey === \"createElement\" || propKey === \"createTextNode\") {\n          return new Proxy(document[propKey], {\n            apply(_createElement, _ctx, args) {\n              const rawCreateMethod = propKey === \"createElement\" ? rawCreateElement : rawCreateTextNode;\n              const element = rawCreateMethod.apply(iframe.contentDocument, args);\n              patchElementEffect(element, iframe.contentWindow);\n              return element;\n            },\n          });\n        }\n        if (propKey === \"documentURI\" || propKey === \"URL\") {\n          return (proxyLocation as Location).href;\n        }\n\n        // from shadowRoot\n        if (\n          propKey === \"getElementsByTagName\" ||\n          propKey === \"getElementsByClassName\" ||\n          propKey === \"getElementsByName\"\n        ) {\n          return new Proxy(shadowRoot.querySelectorAll, {\n            apply(querySelectorAll, _ctx, args) {\n              let arg = args[0];\n              if (_ctx !== iframe.contentDocument) {\n                return _ctx[propKey].apply(_ctx, args);\n              }\n\n              if (propKey === \"getElementsByTagName\" && arg === \"script\") {\n                return iframe.contentDocument.scripts;\n              }\n              if (propKey === \"getElementsByClassName\") arg = \".\" + arg;\n              if (propKey === \"getElementsByName\") arg = `[name=\"${arg}\"]`;\n\n              // FIXME: This string must be a valid CSS selector string; if it's not, a SyntaxError exception is thrown;\n              // so we should ensure that the program can execute normally in case of exceptions.\n              // reference: https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll\n\n              let res: NodeList[] | [];\n              try {\n                res = querySelectorAll.call(shadowRoot, arg);\n              } catch (error) {\n                res = [];\n              }\n\n              return res;\n            },\n          });\n        }\n        if (propKey === \"getElementById\") {\n          return new Proxy(shadowRoot.querySelector, {\n            // case document.querySelector.call\n            apply(target, ctx, args) {\n              if (ctx !== iframe.contentDocument) {\n                return ctx[propKey]?.apply(ctx, args);\n              }\n              try {\n                return (\n                  target.call(shadowRoot, `[id=\"${args[0]}\"]`) ||\n                  iframe.contentWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__.call(\n                    iframe.contentWindow.document,\n                    `#${args[0]}`\n                  )\n                );\n              } catch (error) {\n                warn(WUJIE_TIPS_GET_ELEMENT_BY_ID);\n                return null;\n              }\n            },\n          });\n        }\n        if (propKey === \"querySelector\" || propKey === \"querySelectorAll\") {\n          const rawPropMap = {\n            querySelector: \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\",\n            querySelectorAll: \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__\",\n          };\n          return new Proxy(shadowRoot[propKey], {\n            apply(target, ctx, args) {\n              if (ctx !== iframe.contentDocument) {\n                return ctx[propKey]?.apply(ctx, args);\n              }\n              // 二选一，优先shadowDom，除非采用array合并，排除base，防止对router造成影响\n              return (\n                target.apply(shadowRoot, args) ||\n                (args[0] === \"base\"\n                  ? null\n                  : iframe.contentWindow[rawPropMap[propKey]].call(iframe.contentWindow.document, args[0]))\n              );\n            },\n          });\n        }\n        if (propKey === \"documentElement\" || propKey === \"scrollingElement\") return shadowRoot.firstElementChild;\n        if (propKey === \"forms\") return shadowRoot.querySelectorAll(\"form\");\n        if (propKey === \"images\") return shadowRoot.querySelectorAll(\"img\");\n        if (propKey === \"links\") return shadowRoot.querySelectorAll(\"a\");\n        const { ownerProperties, shadowProperties, shadowMethods, documentProperties, documentMethods } =\n          documentProxyProperties;\n        if (ownerProperties.concat(shadowProperties).includes(propKey.toString())) {\n          if (propKey === \"activeElement\" && shadowRoot.activeElement === null) return shadowRoot.body;\n          return shadowRoot[propKey];\n        }\n        if (shadowMethods.includes(propKey.toString())) {\n          return getTargetValue(shadowRoot, propKey) ?? getTargetValue(document, propKey);\n        }\n        // from window.document\n        if (documentProperties.includes(propKey.toString())) {\n          return document[propKey];\n        }\n        if (documentMethods.includes(propKey.toString())) {\n          return getTargetValue(document, propKey);\n        }\n      },\n    }\n  );\n\n  // proxy location\n  const proxyLocation = new Proxy(\n    {},\n    {\n      get: function (_fakeLocation, propKey) {\n        const location = iframe.contentWindow.location;\n        if (\n          propKey === \"host\" ||\n          propKey === \"hostname\" ||\n          propKey === \"protocol\" ||\n          propKey === \"port\" ||\n          propKey === \"origin\"\n        ) {\n          return urlElement[propKey];\n        }\n        if (propKey === \"href\") {\n          return location[propKey].replace(mainHostPath, appHostPath);\n        }\n        if (propKey === \"reload\") {\n          warn(WUJIE_TIPS_RELOAD_DISABLED);\n          return () => null;\n        }\n        if (propKey === \"replace\") {\n          return new Proxy(location[propKey], {\n            apply(replace, _ctx, args) {\n              return replace.call(location, args[0]?.replace(appHostPath, mainHostPath));\n            },\n          });\n        }\n        return getTargetValue(location, propKey);\n      },\n      set: function (_fakeLocation, propKey, value) {\n        // 如果是跳转链接的话重开一个iframe\n        if (propKey === \"href\") {\n          return locationHrefSet(iframe, value, appHostPath);\n        }\n        iframe.contentWindow.location[propKey] = value;\n        return true;\n      },\n      ownKeys: function () {\n        return Object.keys(iframe.contentWindow.location).filter((key) => key !== \"reload\");\n      },\n      getOwnPropertyDescriptor: function (_target, key) {\n        return { enumerable: true, configurable: true, value: this[key] };\n      },\n    }\n  );\n  return { proxyWindow, proxyDocument, proxyLocation };\n}\n\n/**\n * 降级情况下document、location代理处理\n */\nexport function localGenerator(\n  iframe: HTMLIFrameElement,\n  urlElement: HTMLAnchorElement,\n  mainHostPath: string,\n  appHostPath: string\n): {\n  proxyDocument: Object;\n  proxyLocation: Object;\n} {\n  // 代理 document\n  const proxyDocument = {};\n  const sandbox = iframe.contentWindow.__WUJIE;\n  // 特殊处理\n  Object.defineProperties(proxyDocument, {\n    createElement: {\n      get: () => {\n        return function (...args) {\n          const element = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__.apply(\n            iframe.contentDocument,\n            args\n          );\n          patchElementEffect(element, iframe.contentWindow);\n          return element;\n        };\n      },\n    },\n    createTextNode: {\n      get: () => {\n        return function (...args) {\n          const element = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__.apply(\n            iframe.contentDocument,\n            args\n          );\n          patchElementEffect(element, iframe.contentWindow);\n          return element;\n        };\n      },\n    },\n    documentURI: {\n      get: () => (sandbox.proxyLocation as Location).href,\n    },\n    URL: {\n      get: () => (sandbox.proxyLocation as Location).href,\n    },\n    getElementsByTagName: {\n      get() {\n        return function (...args) {\n          const tagName = args[0];\n          if (tagName === \"script\") {\n            return iframe.contentDocument.scripts as any;\n          }\n          return sandbox.document.getElementsByTagName(tagName) as any;\n        };\n      },\n    },\n  });\n  // 普通处理\n  const {\n    modifyLocalProperties,\n    modifyProperties,\n    ownerProperties,\n    shadowProperties,\n    shadowMethods,\n    documentProperties,\n    documentMethods,\n  } = documentProxyProperties;\n  modifyProperties\n    .filter((key) => !modifyLocalProperties.includes(key))\n    .concat(ownerProperties, shadowProperties, shadowMethods, documentProperties, documentMethods)\n    .forEach((key) => {\n      Object.defineProperty(proxyDocument, key, {\n        get: () => {\n          const value = sandbox.document?.[key];\n          return isCallable(value) ? value.bind(sandbox.document) : value;\n        },\n      });\n    });\n\n  // 代理 location\n  const proxyLocation = {};\n  const location = iframe.contentWindow.location;\n  const locationKeys = Object.keys(location);\n  const constantKey = [\"host\", \"hostname\", \"port\", \"protocol\", \"port\"];\n  constantKey.forEach((key) => {\n    proxyLocation[key] = urlElement[key];\n  });\n  Object.defineProperties(proxyLocation, {\n    href: {\n      get: () => location.href.replace(mainHostPath, appHostPath),\n      set: (value) => {\n        locationHrefSet(iframe, value, appHostPath);\n      },\n    },\n    reload: {\n      get() {\n        warn(WUJIE_TIPS_RELOAD_DISABLED);\n        return () => null;\n      },\n    },\n  });\n  locationKeys\n    .filter((key) => !constantKey.concat([\"href\", \"reload\"]).includes(key))\n    .forEach((key) => {\n      Object.defineProperty(proxyLocation, key, {\n        get: () => (isCallable(location[key]) ? location[key].bind(location) : location[key]),\n      });\n    });\n  return { proxyDocument, proxyLocation };\n}\n"],"mappings":"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"}