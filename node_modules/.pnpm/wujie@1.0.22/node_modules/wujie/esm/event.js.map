{"version":3,"file":"event.js","names":["warn","error","WUJIE_ALL_EVENT","WUJIE_TIPS_NO_SUBJECT","appEventObjMap","window","__POWERED_BY_WUJIE__","__WUJIE","inject","Map","EventBus","id","_classCallCheck","$clear","get","set","eventObj","_createClass","key","value","$on","event","fn","cbs","includes","push","$onAll","$once","on","$off","apply","arguments","bind","length","concat","cb","i","splice","$offAll","$emit","allCbs","forEach","_len","args","Array","_key","l","_cbs","_allCbs","e","_appEventObjMap$get","events","Object","keys"],"sources":["../src/event.ts"],"sourcesContent":["import { warn, error } from \"./utils\";\nimport { WUJIE_ALL_EVENT, WUJIE_TIPS_NO_SUBJECT } from \"./constant\";\n\nexport type EventObj = { [event: string]: Array<Function> };\n\n// 全部事件存储map\nexport const appEventObjMap = window.__POWERED_BY_WUJIE__\n  ? window.__WUJIE.inject.appEventObjMap\n  : new Map<String, EventObj>();\n\n// eventBus 事件中心\nexport class EventBus {\n  private id: string;\n  private eventObj: EventObj;\n\n  constructor(id: string) {\n    this.id = id;\n    this.$clear();\n    if (!appEventObjMap.get(this.id)) {\n      appEventObjMap.set(this.id, {});\n    }\n    this.eventObj = appEventObjMap.get(this.id);\n  }\n\n  // 监听事件\n  public $on(event: string, fn: Function): EventBus {\n    const cbs = this.eventObj[event];\n    if (!cbs) {\n      this.eventObj[event] = [fn];\n      return this;\n    }\n    if (!cbs.includes(fn)) cbs.push(fn);\n    return this;\n  }\n\n  /** 任何$emit都会导致监听函数触发，第一个参数为事件名，后续的参数为$emit的参数 */\n  public $onAll(fn: (event: string, ...args: Array<any>) => any): EventBus {\n    return this.$on(WUJIE_ALL_EVENT, fn);\n  }\n\n  // 一次性监听事件\n  public $once(event: string, fn: Function): void {\n    const on = function (...args: Array<any>) {\n      this.$off(event, on);\n      fn(...args);\n    }.bind(this);\n    this.$on(event, on);\n  }\n\n  // 取消监听\n  public $off(event: string, fn: Function): EventBus {\n    const cbs = this.eventObj[event];\n    if (!event || !cbs || !cbs.length) {\n      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);\n      return this;\n    }\n\n    let cb;\n    let i = cbs.length;\n    while (i--) {\n      cb = cbs[i];\n      if (cb === fn) {\n        cbs.splice(i, 1);\n        break;\n      }\n    }\n    return this;\n  }\n\n  // 取消监听$onAll\n  public $offAll(fn: Function): EventBus {\n    return this.$off(WUJIE_ALL_EVENT, fn);\n  }\n\n  // 发送事件\n  public $emit(event: string, ...args: Array<any>): EventBus {\n    let cbs = [];\n    let allCbs = [];\n\n    appEventObjMap.forEach((eventObj) => {\n      if (eventObj[event]) cbs = cbs.concat(eventObj[event]);\n      if (eventObj[WUJIE_ALL_EVENT]) allCbs = allCbs.concat(eventObj[WUJIE_ALL_EVENT]);\n    });\n\n    if (!event || (cbs.length === 0 && allCbs.length === 0)) {\n      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);\n    } else {\n      try {\n        for (let i = 0, l = cbs.length; i < l; i++) cbs[i](...args);\n        for (let i = 0, l = allCbs.length; i < l; i++) allCbs[i](event, ...args);\n      } catch (e) {\n        error(e);\n      }\n    }\n    return this;\n  }\n\n  // 清空当前所有的监听事件\n  public $clear(): EventBus {\n    const eventObj = appEventObjMap.get(this.id) ?? {};\n    const events = Object.keys(eventObj);\n    events.forEach((event) => delete eventObj[event]);\n    return this;\n  }\n}\n"],"mappings":"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"}